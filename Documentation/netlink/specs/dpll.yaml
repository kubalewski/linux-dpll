name: dpll

doc: DPLL subsystem.

definitions:
  -
    type: const
    name: temp-divider
    value: 10
  -
    type: const
    name: pin-freq-1-hz
    value: 1
  -
    type: const
    name: pin-freq-10-mhz
    value: 10000000
  -
    type: enum
    name: lock-status
    doc: |
      Provides information of dpll device lock status, valid values for
      DPLL_A_LOCK_STATUS attribute
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: unlocked
        doc: |
          dpll was not yet locked to any valid (or is in one of modes:
          DPLL_MODE_FREERUN, DPLL_MODE_NCO)
      -
        name: calibrating
        doc: dpll is trying to lock to a valid signal
      -
        name: locked
        doc: dpll is locked
      -
        name: holdover
        doc: |
          dpll is in holdover state - lost a valid lock or was forced by
          selecting DPLL_MODE_HOLDOVER mode
    render-max: true
  -
    type: enum
    name: pin-type
    doc: Enumerates types of a pin, valid values for DPLL_A_PIN_TYPE attribute
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: mux
        doc: aggregates another layer of selectable pins
      -
        name: ext
        doc: external source
      -
        name: synce-eth-port
        doc: ethernet port PHY's recovered clock
      -
        name: int-oscillator
        doc: device internal oscillator
      -
        name: gnss
        doc: GNSS recovered clock
    render-max: true
  -
    type: enum
    name: pin-state
    doc: available pin modes
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: connected
        doc: pin connected
      -
        name: disconnected
        doc: pin disconnected
    render-max: true
  -
    type: enum
    name: pin-direction
    doc: available pin direction
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: source
        doc: pin used as a source of a signal
      -
        name: output
        doc: pin used to output the signal
    render-max: true
  -
    type: enum
    name: mode
    doc: |
      working-modes a dpll can support, differentiate if and how dpll selects
      one of its sources to syntonize with it
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: manual
        doc: source can be only selected by sending a request to dpll
      -
        name: automatic
        doc: highest prio, valid source, auto selected by dpll
      -
        name: holdover
        doc: dpll forced into holdover mode
      -
        name: freerun
        doc: dpll driven on system clk, no holdover available
      -
        name: nco
        doc: dpll driven by Numerically Controlled Oscillator
    render-max: true
  -
    type: enum
    name: type
    doc: type of dpll, valid values for DPLL_A_TYPE attribute
    entries:
      -
        name: unspec
        doc: unspecified value
      -
        name: pps
        doc: dpll produces Pulse-Per-Second signal
      -
        name: eec
        doc: dpll drives the Ethernet Equipment Clock
  -
    type: enum
    name: event
    doc: events of dpll generic netlink family
    entries:
      -
        name: unspec
        doc: invalid event type
      -
        name: device-create
        doc: dpll device created
      -
        name: device-delete
        doc: dpll device deleted
      -
        name: device-change
        doc: |
          attribute of dpll device or pin changed, reason is to be found with
          an attribute type (DPLL_A_*) received with the event
  -
    type: flags
    name: pin-caps
    doc: define capabilities of a pin
    entries:
      -
        name: direction-can-change
      -
        name: priority-can-change
      -
        name: state-can-change


attribute-sets:
  -
    name: dpll
    enum-name: dplla
    attributes:
      -
        name: dpll
        type: nest
        value: 1
      -
        name: id
        type: u32
      -
        name: dev-name
        type: string
      -
        name: bus-name
        type: string
      -
        name: mode
        type: s32
        enum: mode
      -
        name: mode-supported
        type: s32
      -
        name: source-pin-idx
        type: u32
      -
        name: lock-status
        type: s32
        enum: lock-status
      -
        name: temp
        type: s32
      -
        name: clock-id
        type: u64
      -
        name: type
        type: s32
        enum: type
      -
        name: pin
        type: nest
        nested-attributes: pin
      -
        name: pin-idx
        type: u32
      -
        name: pin-description
        type: string
      -
        name: pin-type
        type: s32
        enum: pin-type
      -
        name: pin-direction
        type: u8
        enum: pin-direction
      -
        name: pin-frequency
        type: u32
      -
        name: pin-frequency-supported
        type: u32
      -
        name: pin-any-frequency-min
        type: u32
      -
        name: pin-any-frequency-max
        type: u32
      -
        name: pin-prio
        type: u32
      -
        name: pin-state
        type: u32
        enum: pin-state
      -
        name: pin-parent
        type: nest
      -
        name: pin-parent-idx
        type: u32
      -
        name: pin-rclk-device
        type: u32
      -
        name: pin-dpll-caps
        type: u32
        enum: pin-dpll-caps
        enum-as-flags: true
  -
    name: pin
    subset-of: dpll
    attributes:
      -
        name: pin-idx
        type: u32
      -
        name: pin-description
        type: string
      -
        name: pin-type
        type: s32
        enum: pin-type
      -
        name: pin-direction
        type: u8
        enum: pin-direction
      -
        name: pin-frequency
        type: u32
      -
        name: pin-frequency-supported
        type: u32
      -
        name: pin-any-frequency-min
        type: u32
      -
        name: pin-any-frequency-max
        type: u32
      -
        name: pin-prio
        type: u32
      -
        name: pin-state
        type: u32
        enum: pin-state
      -
        name: pin-parent
        type: nest
      -
        name: pin-parent-idx
        type: u32
      -
        name: pin-rclk-device
        type: string
      -
        name: pin-dpll-caps
        type: u32
        enum: pin-dpll-caps
        enum-as-flags: true

operations:
  list:
    -
      name: unspec
      doc: unused

    -
      name: device-get
      doc: |
        Get list of DPLL devices (dump) or attributes of a single dpll device
      attribute-set: dpll
      flags: [ admin-perm ]

      do:
        pre: dpll-pre-doit
        request:
          attributes:
            - id
            - bus-name
            - dev-name
        reply: &all_attrs
          attributes:
            - id

      dump:
        pre: dpll-cmd-device-get-start
        request:
          attributes:
            - id
            - bus-name
            - dev-name
        reply: *all_attrs

    -
      name: device-set
      doc: Set attributes for a DPLL device
      attribute-set: dpll
      flags: [ admin-perm ]

      do:
        pre: dpll-pre-doit
        request:
          attributes:
            - id
            - bus-name
            - dev-name
            - mode

    -
      name: pin-get
      doc: |
        Get list of pins and its attributes.
        - dump request without any attributes given - list all the pins in the system
        - dump request with target dpll - list all the pins registered with a given dpll device
        - do request with target dpll and target pin - single pin attributes
      attribute-set: dpll
      flags: [ admin-perm ]

      do:
        pre: dpll-pin-pre-doit
        request:
          attributes:
            - id
            - bus-name
            - dev-name
            - pin-idx

      dump:
        request:
          attributes:
            - id
            - bus-name
            - dev-name
        reply:
          attributes:
            - id
            - bus-name
            - dev-name
            - pin-idx

    -
      name: pin-set
      doc: Set attributes of a target pin
      attribute-set: dpll
      flags: [ admin-perm ]

      do:
        pre: dpll-pin-pre-doit
        request:
          attributes:
            - id
            - bus-name
            - dev-name
            - pin-idx
            - pin-frequency
            - pin-direction
            - pin-prio
            - pin-parent-idx
            - pin-state


mcast-groups:
  list:
    -
      name: monitor
